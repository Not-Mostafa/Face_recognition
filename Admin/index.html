<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Attendance System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab-container {
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .tab-buttons {
            display: flex;
            background: #ecf0f1;
            border-bottom: 1px solid #ddd;
        }
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.3s;
        }
        .tab-btn:hover {
            background: #d6eaf8;
            color: #2980b9;
        }
        .tab-btn.active {
            background: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: 500;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e8f4fc;
        }
        .action-btn {
            padding: 5px 10px;
            margin: 0 3px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .edit-btn {
            background-color: #f39c12;
            color: white;
        }
        .edit-btn:hover {
            background-color: #e67e22;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }
        .add-btn {
            background-color: #2ecc71;
            color: white;
        }
        .add-btn:hover {
            background-color: #27ae60;
        }
        .form-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .submit-btn {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .submit-btn:hover {
            background-color: #2980b9;
        }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .hidden {
            display: none;
        }
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Face Attendance System</h1>
        </header>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="openTab(event, 'students')">Students</button>
                <button class="tab-btn" onclick="openTab(event, 'instructors')">Instructors</button>
                <button class="tab-btn" onclick="openTab(event, 'attendance')">Attendance</button>
                <button class="tab-btn" onclick="openTab(event, 'departments')">Departments</button>
                <button class="tab-btn" onclick="openTab(event, 'courses')">Courses</button>
                <button class="tab-btn" onclick="openTab(event, 'enrollments')">Enrollments</button>
            </div>

            <!-- Students Tab -->
            <div id="students" class="tab-content active">
                <div class="form-container">
                    <h2>Update Student</h2>
                    <div class="form-group">
                        <label for="studentId">Student ID</label>
                        <input type="number" id="studentId" placeholder="Enter student ID">
                    </div>
                    <div class="form-group">
                        <label for="studentName">Name</label>
                        <input type="text" id="studentName" placeholder="Enter new name">
                    </div>
                    <div class="form-group">
                        <label for="studentEmail">Email</label>
                        <input type="email" id="studentEmail" placeholder="Enter new email">
                    </div>
                    <button class="submit-btn" onclick="updateStudent()">Update Student</button>
                    <button class="delete-btn" onclick="deleteStudent()" style="margin-left: 10px;">Delete Student</button>
                    <div id="studentMessage" class="status-message"></div>
                </div>

                <h2>Student List</h2>
                <table id="studentTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Instructors Tab -->
            <div id="instructors" class="tab-content">
                <h2>Instructor List</h2>
                <table id="instructorTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Hire Date</th>
                            <th>Department</th>
                            <th>Salary</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Attendance Tab -->
            <div id="attendance" class="tab-content">
                <h2>Attendance Records</h2>
                <table id="attendanceTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Student</th>
                            <th>Course</th>
                            <th>Date</th>
                            <th>Time In</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Departments Tab -->
            <div id="departments" class="tab-content">
                <div class="action-buttons">
                    <button class="add-btn" onclick="showDepartmentForm()">Add New Department</button>
                </div>

                <div id="departmentFormContainer" class="form-container hidden">
                    <h2 id="departmentFormTitle">Add New Department</h2>
                    <div class="form-group">
                        <label for="departmentId">Department ID (auto-assigned for new departments)</label>
                        <input type="number" id="departmentId" placeholder="Leave empty for new department" disabled>
                    </div>
                    <div class="form-group">
                        <label for="departmentName">Name*</label>
                        <input type="text" id="departmentName" placeholder="Enter department name" required>
                    </div>
                    <div class="form-group">
                        <label for="departmentLocation">Location</label>
                        <input type="text" id="departmentLocation" placeholder="Enter department location">
                    </div>
                    <div class="form-group">
                        <label for="departmentBudget">Budget ($)</label>
                        <input type="number" step="0.01" id="departmentBudget" placeholder="Enter department budget">
                    </div>
                    <button class="submit-btn" onclick="saveDepartment()">Save Department</button>
                    <button class="delete-btn" onclick="cancelDepartmentForm()" style="margin-left: 10px;">Cancel</button>
                    <div id="departmentMessage" class="status-message"></div>
                </div>

                <h2>Department List</h2>
                <table id="departmentTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Budget</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Courses Tab -->
            <div id="courses" class="tab-content">
                <div class="action-buttons">
                    <button class="add-btn" onclick="showCourseForm()">Add New Course</button>
                </div>

                <div id="courseFormContainer" class="form-container hidden">
                    <h2 id="courseFormTitle">Add New Course</h2>
                    <div class="form-group">
                        <label for="courseId">Course ID</label>
                        <input type="number" id="courseId" placeholder="Enter course ID">
                    </div>
                    <div class="form-group">
                        <label for="courseCode">Code</label>
                        <input type="text" id="courseCode" placeholder="Enter course code">
                    </div>
                    <div class="form-group">
                        <label for="courseName">Name</label>
                        <input type="text" id="courseName" placeholder="Enter course name">
                    </div>
                    <div class="form-group">
                        <label for="courseCredits">Credits</label>
                        <input type="number" id="courseCredits" placeholder="Enter credit hours">
                    </div>
                    <div class="form-group">
                        <label for="courseDepartment">Department</label>
                        <select id="courseDepartment">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    <button class="submit-btn" onclick="saveCourse()">Save Course</button>
                    <button class="delete-btn" onclick="cancelCourseForm()" style="margin-left: 10px;">Cancel</button>
                    <div id="courseMessage" class="status-message"></div>
                </div>

                <h2>Course List</h2>
                <table id="courseTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Credits</th>
                            <th>Department</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Enrollments Tab -->
            <div id="enrollments" class="tab-content">
                <h2>Enrollment List</h2>
                <table id="enrollmentTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Student</th>
                            <th>Course</th>
                            <th>Enrollment Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let departments = [];
        let students = [];
        let instructors = [];
        let courses = [];
        let enrollments = [];
        let attendance = [];
        let isEditingDepartment = false;
        let isEditingCourse = false;

        // Tab functionality
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }

            const tabButtons = document.getElementsByClassName("tab-btn");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }

            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");

            // Load data for the active tab
            loadTabData(tabName);
        }

        // Load data for the active tab
        async function loadTabData(tabName) {
            try {
                const response = await fetch(`http://localhost:8000/${tabName}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${tabName}`);
                }
                const data = await response.json();
                console.log(`${tabName} data:`, data);

                if (tabName === 'students') {
                    students = data.data;
                    renderStudents();
                } else if (tabName === 'instructors') {
                    instructors = data.data;
                    renderInstructors();
                } else if (tabName === 'attendance') {
                    attendance = data.data;
                    renderAttendance();
                } else if (tabName === 'departments') {
                    departments = data.data;
                    renderDepartments();
                } else if (tabName === 'courses') {
                    courses = data.data;
                    renderCourses();
                    // Load departments for course form dropdown
                    await loadDepartmentsForDropdown();
                } else if (tabName === 'enrollments') {
                    enrollments = data.data;
                    renderEnrollments();
                }
            } catch (error) {
                console.error(`Error loading ${tabName}:`, error);
                const tableBody = document.querySelector(`#${tabName}Table tbody`);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="color: red; text-align: center;">
                            Error loading data: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Load departments for course form dropdown
        async function loadDepartmentsForDropdown() {
            try {
                const response = await fetch('http://localhost:8000/departments');
                if (!response.ok) {
                    throw new Error('Failed to fetch departments');
                }
                const data = await response.json();
                departments = data.data;

                const dropdown = document.getElementById('courseDepartment');
                dropdown.innerHTML = '<option value="">Select Department</option>';

                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.department_id;
                    option.textContent = dept.name || dept.dep_name || '';
                    dropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading departments for dropdown:', error);
            }
        }

        // Render students table
        function renderStudents() {
            const tableBody = document.querySelector('#studentTable tbody');
            tableBody.innerHTML = '';

            if (students.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No students found</td></tr>';
                return;
            }

            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.student_id}</td>
                    <td>${student.name || student.st_name || ''}</td>
                    <td>${student.email || ''}</td>
                    <td>${student.department_name || 'N/A'}</td>
                    <td>
                        <button class="edit-btn" onclick="populateStudentForm(${student.student_id})">Edit</button>
                        <button class="delete-btn" onclick="confirmDeleteStudent(${student.student_id})">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render instructors table
        function renderInstructors() {
            const tableBody = document.querySelector('#instructorTable tbody');
            tableBody.innerHTML = '';

            if (instructors.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No instructors found</td></tr>';
                return;
            }

            instructors.forEach(instructor => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${instructor.instructor_id}</td>
                    <td>${instructor.name || instructor.in_name || ''}</td>
                    <td>${instructor.email || ''}</td>
                    <td>${instructor.hire_date || ''}</td>
                    <td>${instructor.department_name || 'N/A'}</td>
                    <td>${instructor.salary || 'N/A'}</td>
                    <td>
                        <button class="edit-btn" onclick="populateInstructorForm(${instructor.instructor_id})">Edit</button>
                        <button class="delete-btn" onclick="confirmDeleteInstructor(${instructor.instructor_id})">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render attendance table
        function renderAttendance() {
            const tableBody = document.querySelector('#attendanceTable tbody');
            tableBody.innerHTML = '';

            if (attendance.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No attendance records found</td></tr>';
                return;
            }

            attendance.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.attendance_id}</td>
                    <td>${record.student_name || `Student ${record.student_id}`}</td>
                    <td>${record.course_name || `Course ${record.course_id}`}</td>
                    <td>${record.attendance_date || ''}</td>
                    <td>${record.timestamp_in || 'N/A'}</td>
                    <td>${record.status || ''}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render departments table
        function renderDepartments() {
            const tableBody = document.querySelector('#departmentTable tbody');
            tableBody.innerHTML = '';

            if (departments.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No departments found</td></tr>';
                return;
            }

            departments.forEach(dept => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dept.department_id}</td>
                    <td>${dept.name || dept.dep_name || ''}</td>
                    <td>${dept.location || 'N/A'}</td>
                    <td>${dept.budget ? '$' + dept.budget.toLocaleString() : 'N/A'}</td>
                    <td>
                        <button class="edit-btn" onclick="populateDepartmentForm(${dept.department_id})">Edit</button>
                        <button class="delete-btn" onclick="confirmDeleteDepartment(${dept.department_id})">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render courses table
        function renderCourses() {
            const tableBody = document.querySelector('#courseTable tbody');
            tableBody.innerHTML = '';

            if (courses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No courses found</td></tr>';
                return;
            }

            courses.forEach(course => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${course.course_id}</td>
                    <td>${course.code || ''}</td>
                    <td>${course.name || course.course_name || ''}</td>
                    <td>${course.credits || ''}</td>
                    <td>${course.department_name || 'N/A'}</td>
                    <td>
                        <button class="edit-btn" onclick="populateCourseForm(${course.course_id})">Edit</button>
                        <button class="delete-btn" onclick="confirmDeleteCourse(${course.course_id})">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render enrollments table
        function renderEnrollments() {
            const tableBody = document.querySelector('#enrollmentTable tbody');
            tableBody.innerHTML = '';

            if (enrollments.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No enrollments found</td></tr>';
                return;
            }

            enrollments.forEach(enrollment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${enrollment.enrollment_id}</td>
                    <td>${enrollment.student_name || `Student ${enrollment.student_id}`}</td>
                    <td>${enrollment.course_name || `Course ${enrollment.course_id}`}</td>
                    <td>${enrollment.enrollment_date || ''}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // DEPARTMENT FUNCTIONS
        function showDepartmentForm() {
            isEditingDepartment = false;
            document.getElementById('departmentFormTitle').textContent = 'Add New Department';
            document.getElementById('departmentId').value = '';
            document.getElementById('departmentName').value = '';
            document.getElementById('departmentLocation').value = '';
            document.getElementById('departmentBudget').value = '';
            document.getElementById('departmentFormContainer').classList.remove('hidden');
        }

        function populateDepartmentForm(departmentId) {
            const department = departments.find(d => d.department_id === departmentId);
            if (department) {
                isEditingDepartment = true;
                document.getElementById('departmentFormTitle').textContent = 'Edit Department';
                document.getElementById('departmentId').value = department.department_id;
                document.getElementById('departmentName').value = department.name || department.dep_name || '';
                document.getElementById('departmentLocation').value = department.location || '';
                document.getElementById('departmentBudget').value = department.budget || '';
                document.getElementById('departmentFormContainer').classList.remove('hidden');
            }
        }

        function cancelDepartmentForm() {
            document.getElementById('departmentFormContainer').classList.add('hidden');
            document.getElementById('departmentMessage').textContent = '';
        }

        async function saveDepartment() {
            const departmentId = document.getElementById('departmentId').value;
            const name = document.getElementById('departmentName').value;
            const location = document.getElementById('departmentLocation').value;
            const budget = document.getElementById('departmentBudget').value;

            if (!name) {
                showMessage('departmentMessage', 'Department name is required', false);
                return;
            }

            try {
                let url, method;
                const body = {
                    name: name,
                    location: location || null,
                    budget: budget ? parseFloat(budget) : null
                };

                if (isEditingDepartment) {
                    url = `http://localhost:8000/departments/${departmentId}`;
                    method = 'PUT';
                } else {
                    url = 'http://localhost:8000/departments';
                    method = 'POST';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    showMessage('departmentMessage',
                        `Department ${isEditingDepartment ? 'updated' : 'added'} successfully`,
                        true);
                    loadTabData('departments');
                    cancelDepartmentForm();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save department');
                }
            } catch (error) {
                showMessage('departmentMessage', `Error: ${error.message}`, false);
            }
        }

        async function confirmDeleteDepartment(departmentId) {
            try {
                // First get department name for better messaging
                const dept = departments.find(d => d.department_id === departmentId);
                const deptName = dept ? dept.name || dept.dep_name : '';

                if (confirm(`Are you sure you want to delete department "${deptName}" (ID: ${departmentId})?`)) {
                    const response = await fetch(`http://localhost:8000/departments/${departmentId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showMessage('departmentMessage', `Department "${deptName}" deleted successfully`, true);
                        loadTabData('departments');
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to delete department');
                    }
                }
            } catch (error) {
                showMessage('departmentMessage', `Error: ${error.message}`, false);
            }
        }

        // COURSE FUNCTIONS
        function showCourseForm() {
            isEditingCourse = false;
            document.getElementById('courseFormTitle').textContent = 'Add New Course';
            document.getElementById('courseId').value = '';
            document.getElementById('courseCode').value = '';
            document.getElementById('courseName').value = '';
            document.getElementById('courseCredits').value = '';
            document.getElementById('courseDepartment').value = '';
            document.getElementById('courseFormContainer').classList.remove('hidden');
        }

        function populateCourseForm(courseId) {
            const course = courses.find(c => c.course_id === courseId);
            if (course) {
                isEditingCourse = true;
                document.getElementById('courseFormTitle').textContent = 'Edit Course';
                document.getElementById('courseId').value = course.course_id;
                document.getElementById('courseCode').value = course.code || '';
                document.getElementById('courseName').value = course.name || course.course_name || '';
                document.getElementById('courseCredits').value = course.credits || '';
                document.getElementById('courseDepartment').value = course.department_id || '';
                document.getElementById('courseFormContainer').classList.remove('hidden');
            }
        }

        function cancelCourseForm() {
            document.getElementById('courseFormContainer').classList.add('hidden');
            document.getElementById('courseMessage').textContent = '';
        }

        async function saveCourse() {
            const courseId = document.getElementById('courseId').value;
            const code = document.getElementById('courseCode').value;
            const name = document.getElementById('courseName').value;
            const credits = document.getElementById('courseCredits').value;
            const departmentId = document.getElementById('courseDepartment').value;

            if (!code || !name || !credits || !departmentId) {
                showMessage('courseMessage', 'Please fill in all required fields', false);
                return;
            }

            try {
                let url, method;
                if (isEditingCourse) {
                    url = `http://localhost:8000/courses/${courseId}`;
                    method = 'PUT';
                } else {
                    url = 'http://localhost:8000/courses';
                    method = 'POST';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        name: name,
                        credits: parseInt(credits),
                        department_id: parseInt(departmentId)
                    })
                });

                if (response.ok) {
                    showMessage('courseMessage',
                        `Course ${isEditingCourse ? 'updated' : 'added'} successfully`,
                        true);
                    loadTabData('courses');
                    cancelCourseForm();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save course');
                }
            } catch (error) {
                showMessage('courseMessage', `Error: ${error.message}`, false);
            }
        }

        async function confirmDeleteCourse(courseId) {
            if (confirm(`Are you sure you want to delete course with ID ${courseId}?`)) {
                try {
                    const response = await fetch(`http://localhost:8000/courses/${courseId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showMessage('courseMessage', 'Course deleted successfully', true);
                        loadTabData('courses');
                    } else {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to delete course');
                    }
                } catch (error) {
                    showMessage('courseMessage', `Error: ${error.message}`, false);
                }
            }
        }

        // STUDENT FUNCTIONS
        function populateStudentForm(studentId) {
            const student = students.find(s => s.student_id === studentId);
            if (student) {
                document.getElementById('studentId').value = student.student_id;
                document.getElementById('studentName').value = student.name || student.st_name || '';
                document.getElementById('studentEmail').value = student.email || '';
            }
        }

        async function updateStudent() {
            const studentId = document.getElementById('studentId').value;
            const name = document.getElementById('studentName').value;
            const email = document.getElementById('studentEmail').value;

            if (!studentId) {
                showMessage('studentMessage', 'Please enter a student ID', false);
                return;
            }

            try {
                const response = await fetch(`http://localhost:8000/students/${studentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        st_name: name || undefined,
                        email: email || undefined
                    })
                });

                if (response.ok) {
                    showMessage('studentMessage', 'Student updated successfully', true);
                    loadTabData('students');
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update student');
                }
            } catch (error) {
                showMessage('studentMessage', `Error: ${error.message}`, false);
            }
        }

        async function deleteStudent() {
            const studentId = document.getElementById('studentId').value;

            if (!studentId) {
                showMessage('studentMessage', 'Please enter a student ID', false);
                return;
            }

            if (!confirm(`Are you sure you want to delete student with ID ${studentId}?`)) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:8000/students/${studentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('studentMessage', 'Student deleted successfully', true);
                    document.getElementById('studentId').value = '';
                    document.getElementById('studentName').value = '';
                    document.getElementById('studentEmail').value = '';
                    loadTabData('students');
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete student');
                }
            } catch (error) {
                showMessage('studentMessage', `Error: ${error.message}`, false);
            }
        }

        function confirmDeleteStudent(studentId) {
            if (confirm(`Are you sure you want to delete student with ID ${studentId}?`)) {
                document.getElementById('studentId').value = studentId;
                deleteStudent();
            }
        }

        // INSTRUCTOR FUNCTIONS - ADDED TO FIX EDIT/DELETE
        function populateInstructorForm(instructorId) {
            const instructor = instructors.find(i => i.instructor_id === instructorId);
            if (instructor) {
                // Create a form container
                const formHTML = `
                    <div class="form-container" id="instructorEditFormContainer">
                        <h2>Edit Instructor</h2>
                        <div class="form-group">
                            <label for="editInstructorId">Instructor ID</label>
                            <input type="number" id="editInstructorId" value="${instructor.instructor_id}" disabled>
                        </div>
                        <div class="form-group">
                            <label for="editInstructorName">Name*</label>
                            <input type="text" id="editInstructorName" value="${instructor.in_name || instructor.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editInstructorEmail">Email*</label>
                            <input type="email" id="editInstructorEmail" value="${instructor.email || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editInstructorHireDate">Hire Date</label>
                            <input type="date" id="editInstructorHireDate" value="${instructor.hire_date || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editInstructorSalary">Salary</label>
                            <input type="number" step="0.01" id="editInstructorSalary" value="${instructor.salary || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editInstructorDepartment">Department</label>
                            <select id="editInstructorDepartment">
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <button class="submit-btn" onclick="updateInstructor()">Update Instructor</button>
                        <button class="delete-btn" onclick="closeInstructorForm()" style="margin-left: 10px;">Cancel</button>
                        <div id="instructorEditMessage" class="status-message"></div>
                    </div>
                `;

                // Create or update the form container
                let formContainer = document.getElementById('instructorEditFormContainer');
                if (!formContainer) {
                    formContainer = document.createElement('div');
                    formContainer.id = 'instructorEditFormContainer';
                    document.getElementById('instructors').prepend(formContainer);
                }
                formContainer.innerHTML = formHTML;

                // Load departments into dropdown
                loadDepartmentsForInstructorDropdown(instructor.department_id);
            }
        }

        async function loadDepartmentsForInstructorDropdown(selectedDepartmentId = null) {
            try {
                const response = await fetch('http://localhost:8000/departments');
                if (!response.ok) {
                    throw new Error('Failed to fetch departments');
                }
                const data = await response.json();
                const dropdown = document.getElementById('editInstructorDepartment');
                dropdown.innerHTML = '<option value="">Select Department</option>';

                data.data.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.department_id;
                    option.textContent = dept.name || dept.dep_name || '';
                    option.selected = (dept.department_id == selectedDepartmentId);
                    dropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading departments for dropdown:', error);
            }
        }

        function closeInstructorForm() {
            const formContainer = document.getElementById('instructorEditFormContainer');
            if (formContainer) {
                formContainer.remove();
            }
        }

        async function updateInstructor() {
            const instructorId = document.getElementById('editInstructorId').value;
            const name = document.getElementById('editInstructorName').value;
            const email = document.getElementById('editInstructorEmail').value;
            const hireDate = document.getElementById('editInstructorHireDate').value;
            const salary = document.getElementById('editInstructorSalary').value;
            const departmentId = document.getElementById('editInstructorDepartment').value;

            if (!name || !email) {
                showMessage('instructorEditMessage', 'Name and email are required', false);
                return;
            }

            try {
                const response = await fetch(`http://localhost:8000/instructors/${instructorId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        in_name: name,
                        email: email,
                        hire_date: hireDate || null,
                        salary: salary ? parseFloat(salary) : null,
                        department_id: departmentId ? parseInt(departmentId) : null
                    })
                });

                if (response.ok) {
                    showMessage('instructorEditMessage', 'Instructor updated successfully', true);
                    loadTabData('instructors');
                    setTimeout(closeInstructorForm, 1500);
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update instructor');
                }
            } catch (error) {
                showMessage('instructorEditMessage', `Error: ${error.message}`, false);
            }
        }

        async function confirmDeleteInstructor(instructorId) {
            const instructor = instructors.find(i => i.instructor_id === instructorId);
            const instructorName = instructor ? instructor.in_name || instructor.name : '';

            if (confirm(`Are you sure you want to delete instructor "${instructorName}" (ID: ${instructorId})?`)) {
                try {
                    const response = await fetch(`http://localhost:8000/instructors/${instructorId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showMessage('instructorMessage', `Instructor "${instructorName}" deleted successfully`, true);
                        loadTabData('instructors');
                    } else {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to delete instructor');
                    }
                } catch (error) {
                    showMessage('instructorMessage', `Error: ${error.message}`, false);
                }
            }
        }

        // Show status message
        function showMessage(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-message ${isSuccess ? 'success' : 'error'}`;
            setTimeout(() => {
                element.textContent = '';
                element.className = 'status-message';
            }, 5000);
        }

        // Initialize the page
        async function initialize() {
            try {
                // Load departments first (for any dropdowns)
                const deptResponse = await fetch('http://localhost:8000/departments');
                if (deptResponse.ok) {
                    const deptData = await deptResponse.json();
                    departments = deptData.data;
                }

                // Load the initial tab (students)
                loadTabData('students');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>